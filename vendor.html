<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Input - Daily Transport</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-100 font-sans text-gray-800">
    <div class="max-w-md mx-auto min-h-screen flex flex-col p-4">
        <div class="bg-blue-600 rounded-2xl p-6 shadow-lg text-white mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black">Update Status Armada</h1>
                <p class="text-blue-100 text-sm">Daily Transport System</p>
            </div>
            <button onclick="logout()" class="bg-red-500 p-2 rounded-lg text-xs font-bold">LOGOUT</button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-6 space-y-5">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Nama Vendor</label>
                <select id="inputVendor" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 font-bold text-blue-900 outline-none">
                    <option value="">-- Pilih Vendor --</option>
                    <option>Respek</option><option>Wira</option><option>Fesa</option><option>Humala</option><option>Matio</option>
                    <option>Sinergi</option><option>Tam</option><option>Yas</option><option>Kms</option><option>Tangguh Jaya Pratama</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Plat Nomor</label>
                <input type="text" id="inputPlat" placeholder="B 1234 ABC" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 font-bold uppercase outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Nama Customer - Daerah</label>
    <input type="text" id="inputCustomer" placeholder="Contoh: Mitra 10 Karawang" 
           class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 font-bold uppercase outline-none focus:ring-2 focus:ring-blue-500">
</div>
          <div>
    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Nomor DT (Bisa banyak, pisahkan dengan koma)</label>
    <textarea id="inputDT" placeholder="Contoh: 17522, 17566, 17588" 
        class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 font-bold outline-none focus:ring-2 focus:ring-blue-500" 
        rows="2"></textarea>
</div>

    <div>
        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Foto Bukti (Wajib)</label>
        <input type="file" id="inputFoto" accept="image/*" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        <canvas id="tempCanvas" class="hidden"></canvas>
    </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Status:</label>
                <div class="grid grid-cols-2 gap-3" id="statusGroup">
                    <button onclick="setStatus('Antri Muat', this)" class="p-3 rounded-xl border border-gray-200 text-xs font-bold transition">Antri Muat</button>
                    <button onclick="setStatus('Otw Customer', this)" class="p-3 rounded-xl border border-gray-200 text-xs font-bold transition">Otw Customer</button>
                    <button onclick="setStatus('Antri Bongkar', this)" class="p-3 rounded-xl border border-gray-200 text-xs font-bold transition">Antri Bongkar</button>
                    <button onclick="setStatus('Selesai', this)" class="p-3 rounded-xl border border-gray-200 text-xs font-bold transition">Selesai</button>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Catatan</label>
                <textarea id="inputNote" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm outline-none"></textarea>
            </div>
            <button onclick="submitData()" id="sendBtn" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg transition active:scale-95">KIRIM UPDATE</button>
        </div>
        <p class="text-[10px] text-gray-400 mt-6 text-center italic">Hi Yas! Keep Fight Ya!</p>
    </div>

    <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"; // Tambahkan Storage
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyB7aqBfuhB618yiO9Ss1sXmirNZOGMgCoo",
    authDomain: "status-pengiriman.firebaseapp.com",
    projectId: "status-pengiriman",
    storageBucket: "status-pengiriman.firebasestorage.app",
    messagingSenderId: "642881748809",
    appId: "1:642881748809:web:af8719db3a37e731d6e498"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app); // Inisialisasi Storage
const auth = getAuth(app);

let currentStatus = "";

window.setStatus = (status, el) => {
    currentStatus = status;
    document.querySelectorAll('#statusGroup button').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
    el.classList.add('bg-blue-600', 'text-white');

    // Tampilkan input file HANYA jika status Selesai
    const uploadBox = document.getElementById('uploadContainer');
    if (status === 'Selesai') {
        uploadBox.classList.remove('hidden');
    } else {
        uploadBox.classList.add('hidden');
    }
};

window.submitData = async () => {
    const vendor = document.getElementById('inputVendor').value;
    const plat = document.getElementById('inputPlat').value;
    // 1. AMBIL VALUE CUSTOMER
    const customer = document.getElementById('inputCustomer').value; 
    const nomorDT = document.getElementById('inputDT').value;
    const note = document.getElementById('inputNote').value;
    const fotoFile = document.getElementById('inputFoto').files[0];
    const btn = document.getElementById('sendBtn');

    // 2. VALIDASI (Pastikan customer juga diisi)
    if(!vendor || !plat || !customer || !currentStatus) return alert("Lengkapi data termasuk Customer!");

    if (currentStatus === 'Selesai' && !fotoFile) {
        return alert("Tolong lampirkan bukti pengiriman ya bapa - bapa ! :)");
    }

    btn.disabled = true; 
    btn.innerText = "MENGIRIM...";

    let fotoBase64 = "";

    if (fotoFile) {
        fotoBase64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(fotoFile);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.getElementById('tempCanvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 400;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                };
            };
        });
    }

    try {
        // 3. SIMPAN KE FIREBASE
        await addDoc(collection(db, "deliveries"), {
            vendor, 
            plat, 
            customer: customer, // Data baru masuk sini
            nomorDT: nomorDT || "-", 
            status: currentStatus, 
            note, 
            foto: fotoBase64, 
            timestamp: serverTimestamp()
        });
        alert("Status Berhasil Diperbarui!");
        location.reload();
    } catch (e) { 
        alert("Error: " + e.message); 
        btn.disabled = false; 
        btn.innerText = "KIRIM UPDATE";
    }
};
window.logout = () => {
    if(confirm("Apakah Anda yakin ingin keluar?")) {
        signOut(auth).then(() => {
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error("Logout Error:", error);
        });
    }
};
window.logout = () => signOut(auth).then(() => window.location.href = 'login.html');
    </script>
</body>
</html>
