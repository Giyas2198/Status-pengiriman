<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Transport Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .sidebar-gradient { background: linear-gradient(180deg, #2563eb 0%, #1e40af 100%); }
        .detail-box { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-height: 0; overflow: hidden; opacity: 0; }
        .detail-box.active {max-height: 80vh; /* Membatasi tinggi detail maksimal 80% tinggi layar agar tidak tenggelam */
         opacity: 1; margin-bottom: 2rem; overflow-y: auto; /* PENTING: Mengaktifkan scroll vertikal jika data banyak */
         padding-right: 10px; /* Memberi ruang untuk scrollbar */ 
        }
        .card-active { ring: 4px solid #93c5fd; transform: scale(1.02); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 sidebar-gradient text-white flex flex-col shadow-2xl z-30">
            <div class="p-6 border-b border-blue-400/30">
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-2 rounded-lg text-blue-600 shadow-md">
                        <i class="fas fa-truck-loading fa-lg"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight">Daily Transport</span>
                </div>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="flex items-center space-x-3 bg-white/10 px-4 py-3 rounded-xl border border-white/20">
                    <i class="fas fa-th-large w-5"></i>
                    <span>Dashboard</span>
                </a>
            </nav>
            <div class="p-6 border-t border-blue-400/30 text-xs text-blue-100 italic">
                Hi Jotun Team! Keep Fight Ya! <br> Â© 2026 giyas Logistics Ops
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-y-auto">
            <header class="bg-white shadow-sm px-8 py-4 flex justify-between items-center sticky top-0 z-20">
                <h1 class="font-bold text-xl text-blue-900 tracking-tight">Monitoring Status</h1>
                
                <div class="flex items-center space-x-2">
                    <button id="btnExportHeader" class="hidden text-[10px] bg-green-600 text-white px-3 py-2 rounded-lg font-bold hover:bg-green-700 shadow-sm transition">
                        <i class="fas fa-file-excel mr-1"></i> EXCEL
                    </button>
                    <button id="btnBlastEmail" class="hidden text-[10px] bg-blue-600 text-white px-3 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-sm transition">
                        <i class="fas fa-paper-plane mr-1"></i> BLAST ALL
                    </button>
                    <button id="btnCustomEmail" class="hidden text-[10px] bg-purple-600 text-white px-3 py-2 rounded-lg font-bold hover:bg-purple-700 shadow-sm transition">
                        <i class="fas fa-envelope mr-1"></i> CUSTOM SEND
                    </button>

                    <div class="text-right ml-4">
                        <select id="vendorFilter" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-1 font-bold focus:ring-2 focus:ring-blue-500 outline-none w-40">
                            <option value="All">Semua Vendor</option>
                            <option value="Respek">Respek</option>
                            <option value="Wira">Wira</option>
                            <option value="Fesa">Fesa</option>
                            <option value="Humala">Humala</option>
                            <option value="Matio">Matio</option>
                            <option value="Sinergi">Sinergi</option>
                            <option value="Tam">Tam</option>
                            <option value="Yas">Yas</option>
                            <option value="Kms">Kms</option>
                            <option value="Tangguh Jaya Pratama">Tangguh Jaya Pratama</option>
                        </select>
                    </div>
                    <button onclick="logout()" class="text-[10px] bg-red-100 text-red-600 px-3 py-2 rounded-lg font-bold">LOGOUT</button>
                </div>
            </header>

            <div class="p-8">
                <div class="mb-6">
                    <h2 class="text-2xl font-black text-gray-800">Dashboard <span id="vendorTitle" class="text-blue-600">Semua Vendor</span></h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div onclick="toggleDetail('Antri Muat', this)" class="cursor-pointer bg-blue-600 p-6 rounded-2xl shadow-lg text-white hover:bg-blue-700 transition-all">
                        <p class="text-xs font-bold opacity-80 uppercase tracking-widest">Antri Muat</p>
                        <h3 class="text-4xl font-black mt-1" id="valAntri">0</h3>
                    </div>
                    <div onclick="toggleDetail('Otw Customer', this)" class="cursor-pointer bg-emerald-500 p-6 rounded-2xl shadow-lg text-white hover:bg-emerald-600 transition-all">
                        <p class="text-xs font-bold opacity-80 uppercase tracking-widest">Otw Customer</p>
                        <h3 class="text-4xl font-black mt-1" id="valOtw">0</h3>
                    </div>
                    <div onclick="toggleDetail('Antri Bongkar', this)" class="cursor-pointer bg-amber-500 p-6 rounded-2xl shadow-lg text-white hover:bg-amber-600 transition-all">
                        <p class="text-xs font-bold opacity-80 uppercase tracking-widest">Antri Bongkar</p>
                        <h3 class="text-4xl font-black mt-1" id="valBongkar">0</h3>
                    </div>
                    <div onclick="toggleDetail('Selesai', this)" class="cursor-pointer bg-rose-500 p-6 rounded-2xl shadow-lg text-white hover:bg-rose-600 transition-all">
                        <p class="text-xs font-bold opacity-80 uppercase tracking-widest">Selesai</p>
                        <h3 class="text-4xl font-black mt-1" id="valSelesai">0</h3>
                    </div>
                </div>

                <div id="detailContainer" class="detail-box">
                    <div class="bg-white border-l-8 border-blue-600 shadow-xl rounded-xl p-6 relative">
                        <button onclick="closeDetail()" class="absolute top-4 right-4 text-gray-300 hover:text-red-500"><i class="fas fa-times-circle fa-lg"></i></button>
                        <h4 id="detailTitle" class="font-black text-xl text-gray-800 mb-4 border-b pb-2">Detail Data</h4>
                        <ul id="detailList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, where, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7aqBfuhB618yiO9Ss1sXmirNZOGMgCoo",
            authDomain: "status-pengiriman.firebaseapp.com",
            projectId: "status-pengiriman",
            storageBucket: "status-pengiriman.firebasestorage.app",
            messagingSenderId: "642881748809",
            appId: "1:642881748809:web:af8719db3a37e731d6e498"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allDeliveries = [];
        let userRole = "";

        // 1. Cek Auth & Set Tombol
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "Users", user.uid));
                if (userDoc.exists()) {
                    userRole = userDoc.data().Role;
                    if (userRole === 'editor' || userRole === 'admin') {
                        ['btnExportHeader', 'btnBlastEmail', 'btnCustomEmail'].forEach(id => {
                            const el = document.getElementById(id);
                            if(el) el.classList.remove('hidden');
                        });
                        document.getElementById('btnExportHeader').onclick = () => exportToExcel();
                        document.getElementById('btnBlastEmail').onclick = () => sendEmail('blast');
                        document.getElementById('btnCustomEmail').onclick = () => sendEmail('custom');
                    }
                    listenUpdates();
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // 2. Monitoring Real-time
        function listenUpdates(vendor = 'All') {
            let q = collection(db, "deliveries");
            if (vendor !== 'All') q = query(q, where("vendor", "==", vendor));

            onSnapshot(q, (snapshot) => {
                allDeliveries = [];
                const counts = { 'Antri Muat': 0, 'Otw Customer': 0, 'Antri Bongkar': 0, 'Selesai': 0 };
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allDeliveries.push({ ...data, id: doc.id });
                    if (counts[data.status] !== undefined) counts[data.status]++;
                });
                document.getElementById('valAntri').innerText = counts['Antri Muat'];
                document.getElementById('valOtw').innerText = counts['Otw Customer'];
                document.getElementById('valBongkar').innerText = counts['Antri Bongkar'];
                document.getElementById('valSelesai').innerText = counts['Selesai'];
            });
        }

        // 3. Export Excel
        window.exportToExcel = () => {
            if (allDeliveries.length === 0) return alert("Data kosong!");
            const reportData = allDeliveries.map((item, index) => ({
                "No": index + 1,
                "Tanggal": item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('id-ID') : "-",
                "Vendor": item.vendor,
                "Plat Nomor": item.plat,
                "Nomor DT": item.nomorDT || "-",
                "Status": item.status,
                "Catatan": item.note || "-"
            }));
            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            XLSX.writeFile(wb, `Rekap_Daily_Transport_${new Date().toLocaleDateString()}.xlsx`);
        };

        // 4. Kirim Email (Blast/Custom)
        window.sendEmail = async (mode) => {
            if (allDeliveries.length === 0) return alert("Data kosong!");
            let targetEmail = (mode === 'custom') ? prompt("Masukkan email tujuan:") : "";
            if (mode === 'custom' && !targetEmail) return;

            if (!confirm("Kirim data sekarang?")) return;

            // GANTI URL DI BAWAH DENGAN URL DEPLOY GAS TERBARU KAMU
            const GAS_URL = "https://script.google.com/macros/s/AKfycbzbPTfLaW1nGK_wqYqioVK05kBZWaprmEYSFFPz49G7IjRN3Guc4Q_wrqeUg2Kt3Euw/exec";

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ mode, target: targetEmail, data: allDeliveries })
                });
                alert("Selesai! Cek folder Terkirim di Gmail.");
            } catch (e) { alert("Error: " + e.message); }
        };

// Fungsi Menampilkan Detail Data
window.toggleDetail = (status, el) => {
    // 1. Atur Tampilan Kartu Aktif
    document.querySelectorAll('.grid > div').forEach(c => c.classList.remove('card-active'));
    el.classList.add('card-active');

    // 2. Filter Data dengan Logika yang Lebih Aman (Trim spasi dan abaikan Case Sensitive)
    const filtered = allDeliveries.filter(d => 
        d.status && d.status.trim().toLowerCase() === status.trim().toLowerCase()
    );
    
    // 3. Update Judul Detail
    document.getElementById('detailTitle').innerText = `Detail: ${status} (${filtered.length} Data)`;

    // 4. Render List Data
    const list = document.getElementById('detailList');
    
    if (filtered.length === 0) {
        list.innerHTML = `<p class="col-span-full text-center text-gray-400 py-10">Tidak ada data untuk status ini.</p>`;
    } else {
        list.innerHTML = filtered.map((item, i) => `
            <li class="p-4 bg-slate-50 rounded-xl border border-gray-100 flex flex-col shadow-sm transition hover:shadow-md">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-blue-900 uppercase text-lg">${item.plat || 'Tanpa Plat'}</p>
                        <p class="text-xs font-bold text-amber-600">No DT: ${item.nomorDT || '-'}</p>
                        <p class="text-xs font-bold text-gray-500 mt-1">
                            <i class="fas fa-map-marker-alt mr-1"></i> ${item.customer || '-'}
                        </p>
                    </div>
                    <span class="text-[10px] bg-gray-200 px-2 py-1 rounded font-bold text-gray-500">${item.vendor || 'Tanpa Vendor'}</span>
                </div>

                ${item.statusDT === 'KEMBALI' ? 
                    `<div class="mt-3 bg-green-100 border border-green-200 p-2 rounded-lg text-center">
                        <p class="text-[10px] text-green-700 font-black uppercase"><i class="fas fa-check-circle"></i> DT SUDAH KEMBALI</p>
                        <p class="text-[9px] text-green-600 mt-1">
                           Diterima: ${item.tanggalBalikDT ? new Date(item.tanggalBalikDT).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'}) : '-'}
                        </p>
                     </div>` 
                    : 
                    `<div class="mt-3 bg-red-50 border border-red-100 p-2 rounded-lg text-center opacity-80">
                        <p class="text-[10px] text-red-400 font-bold uppercase"><i class="fas fa-clock"></i> DT BELUM KEMBALI</p>
                     </div>`
                }

                <p class="text-[11px] text-gray-500 italic mt-3 border-t border-gray-200 pt-2">
                    Catatan: "${item.note || 'Tidak ada catatan'}"
                </p>

                ${userRole === 'editor' || userRole === 'admin' ? 
                    `<button onclick="deleteData('${item.id}')" class="w-full mt-3 py-2 text-red-500 text-[10px] font-bold border border-red-200 rounded hover:bg-red-50 transition">
                        <i class="fas fa-trash"></i> HAPUS DATA
                    </button>` : ''
                }

                ${item.foto ? 
                    `<div class="mt-3">
                        <p class="text-[9px] text-gray-400 mb-1">Bukti Foto:</p>
                        <img src="${item.foto}" class="w-full h-32 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-90" onclick="window.open(this.src)">
                     </div>` : ''
                }
            </li>
        `).join('');
    }

    // 5. Munculkan Container Detail
    document.getElementById('detailContainer').classList.add('active');
};

        window.closeDetail = () => document.getElementById('detailContainer').classList.remove('active');
        window.logout = () => { if(confirm("Logout?")) signOut(auth).then(() => window.location.href='login.html'); };
        
        document.getElementById('vendorFilter').addEventListener('change', (e) => {
            document.getElementById('vendorTitle').innerText = e.target.value === 'All' ? 'Semua Vendor' : e.target.value;
            listenUpdates(e.target.value);
            window.closeDetail();
        });
    </script>
</body>
</html>


