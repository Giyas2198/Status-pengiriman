<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfirmasi Fisik DT - Jotun Logistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-slate-200 min-h-screen flex items-center justify-center p-4">

    <div class="glass-effect max-w-md w-full rounded-3xl shadow-2xl border border-white/50 overflow-hidden relative">
        
        <div class="bg-blue-600 p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
            <h1 class="text-white font-black text-2xl tracking-tight relative z-10">KONFIRMASI DT</h1>
            <p class="text-blue-100 text-xs relative z-10">Verifikasi Pengembalian Dokumen Fisik</p>
        </div>

        <div class="p-8">
            
            <div id="loading" class="text-center py-10 space-y-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto"></div>
                <p class="text-gray-500 font-bold animate-pulse">Mengambil Data Pengiriman...</p>
            </div>

            <div id="content" class="hidden space-y-6">
                
                <div class="bg-slate-50 rounded-2xl p-5 border border-slate-200 shadow-inner">
                    <div class="flex justify-between items-start border-b border-slate-200 pb-3 mb-3">
                        <div>
                            <p class="text-[10px] uppercase text-gray-400 font-bold tracking-wider">Vendor</p>
                            <p id="dispVendor" class="font-bold text-gray-700 text-lg">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] uppercase text-gray-400 font-bold tracking-wider">Plat Nomor</p>
                            <div class="bg-black text-white px-3 py-1 rounded text-sm font-bold font-mono inline-block" id="dispPlat">B ---- ---</div>
                        </div>
                    </div>

                    <div>
                        <p class="text-[10px] uppercase text-blue-500 font-bold tracking-wider mb-1">Nomor DT / Surat Jalan</p>
                        <p id="dispDT" class="text-2xl font-black text-blue-900 break-words leading-tight">...</p>
                    </div>
                </div>

                <div class="flex items-start gap-3 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                    <i class="fas fa-exclamation-circle text-yellow-600 mt-1"></i>
                    <p class="text-xs text-yellow-700 leading-relaxed">
                        <strong>PENTING:</strong> Klik tombol di bawah HANYA jika fisik dokumen (Hard Copy) surat jalan sudah diterima oleh Admin.
                    </p>
                </div>

                <button onclick="processConfirmation()" id="btnAction" class="group w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex items-center justify-center gap-3">
                    <span class="bg-white/20 p-1 rounded-full"><i class="fas fa-check text-xs"></i></span>
                    <span>KONFIRMASI DITERIMA</span>
                </button>

            </div>

            <div id="success" class="hidden text-center py-6">
                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                    <i class="fas fa-clipboard-check text-5xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">TERKONFIRMASI!</h2>
                <p class="text-gray-500 text-sm mb-6">Status dokumen telah diperbarui menjadi <br><strong class="text-green-600">KEMBALI</strong></p>
                
                <div class="bg-gray-100 rounded-lg p-3 text-xs text-gray-500 font-mono">
                    Waktu: <span id="timestamp"></span>
                </div>
            </div>

             <div id="errorState" class="hidden text-center py-10">
                <i class="fas fa-times-circle text-red-500 text-4xl mb-3"></i>
                <p id="errorMessage" class="text-red-500 font-bold">Data tidak ditemukan.</p>
            </div>

        </div>

        <div class="bg-gray-50 p-4 text-center border-t border-gray-100">
            <p class="text-[10px] text-gray-400">System by Giyas Logistics Â© 2026</p>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDK (Sesuai dengan index.html kamu)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Konfigurasi Firebase (Sama persis dengan file index.html kamu)
        const firebaseConfig = {
            apiKey: "AIzaSyB7aqBfuhB618yiO9Ss1sXmirNZOGMgCoo",
            authDomain: "status-pengiriman.firebaseapp.com",
            projectId: "status-pengiriman",
            storageBucket: "status-pengiriman.firebasestorage.app",
            messagingSenderId: "642881748809",
            appId: "1:642881748809:web:af8719db3a37e731d6e498"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ambil ID dari URL (?id=xxxx)
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        // Referensi Elemen UI
        const elLoading = document.getElementById('loading');
        const elContent = document.getElementById('content');
        const elSuccess = document.getElementById('success');
        const elError = document.getElementById('errorState');
        const elBtn = document.getElementById('btnAction');

        // Fungsi Utama: Load Data saat halaman dibuka
        async function loadData() {
            if (!docId) {
                showError("Link tidak valid (ID tidak ditemukan).");
                return;
            }

            try {
                const docRef = doc(db, "deliveries", docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Isi data ke tampilan
                    document.getElementById('dispVendor').innerText = data.vendor || "-";
                    document.getElementById('dispPlat').innerText = data.plat || "-";
                    document.getElementById('dispDT').innerText = data.nomorDT || "-";

                    // Logika Cerdas: Cek apakah sudah dikonfirmasi sebelumnya?
                    if (data.statusDT === "KEMBALI") {
                        showSuccess(data.tanggalBalikDT);
                    } else {
                        // Jika belum, tampilkan form konfirmasi
                        elLoading.classList.add('hidden');
                        elContent.classList.remove('hidden');
                    }

                } else {
                    showError("Data pengiriman tidak ditemukan di database.");
                }
            } catch (error) {
                console.error("Error:", error);
                showError("Terjadi kesalahan koneksi: " + error.message);
            }
        }

        // Fungsi: Proses Konfirmasi (Saat tombol diklik)
        window.processConfirmation = async () => {
            if(!confirm("Yakin dokumen fisik DT/Surat Jalan sudah diterima Admin?")) return;

            // UI Loading di tombol
            elBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> MEMPROSES...';
            elBtn.disabled = true;
            elBtn.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                const now = new Date().toISOString();

                // UPDATE STATUS KE FIREBASE
                // Ini yang bikin Dashboard jadi HIJAU otomatis
                await updateDoc(doc(db, "deliveries", docId), {
                    statusDT: "KEMBALI",      // Status kunci
                    tanggalBalikDT: now       // Waktu pengembalian
                });

                // Tampilkan sukses
                showSuccess(now);

            } catch (error) {
                console.error("Update Error:", error);
                alert("Gagal update: " + error.message);
                elBtn.innerHTML = 'COBA LAGI';
                elBtn.disabled = false;
                elBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        };

        // Helper: Tampilkan Layar Sukses
        function showSuccess(timestampString) {
            elLoading.classList.add('hidden');
            elContent.classList.add('hidden');
            elSuccess.classList.remove('hidden');

            const dateObj = new Date(timestampString);
            document.getElementById('timestamp').innerText = 
                dateObj.toLocaleDateString('id-ID', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
        }

        // Helper: Tampilkan Layar Error
        function showError(msg) {
            elLoading.classList.add('hidden');
            elContent.classList.add('hidden');
            elError.classList.remove('hidden');
            document.getElementById('errorMessage').innerText = msg;
        }

        // Jalankan saat load
        loadData();
    </script>
</body>
</html>
